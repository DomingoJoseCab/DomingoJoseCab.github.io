<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>b6591e720aae45e486cdfeaf0d75ee4c</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="computer-vision-predicción-de-números-mediante-redes-neuronales" class="cell markdown">
<h1>Computer Vision: Predicción de números mediante redes neuronales</h1>
<h3 id="realizado-por-domingo-josé-caballero-navarro">Realizado por: Domingo José Caballero Navarro</h3>
<ul>
<li><h4 id="linkedin"><a href="https://www.linkedin.com/in/domingo-jos%C3%A9-caballero-navarro-56a29a24b/">Linkedin</a></h4></li>
<li><h4 id="portfolio"><a href="https://domingojosecab.github.io/">Portfolio</a></h4></li>
</ul>
</section>
<section id="índice" class="cell markdown">
<h2>Índice</h2>
<ol>
    <a href="#introduccion"><b><li>Introducción y carga de librerias</li></b></a>
    <a href="#visualizacion"><b><li>Visualización y estudio de las imágenes del conjunto entrenamiento</li></b></a>
    <a href="#prep"><b><li>Preprocesamiento de las imágenes</li></b></a>
    <a href="#neuronal"><b><li>Primera aproximación: elaboración de una red neuronal inicial</li></b></a>
    <a href="#convolucional"><b><li>Segunda aproximación: elaboracion de redes convolucionales</li></b></a>
    <a href="#ensemble"><b><li>Tercera aproximación: modelos creados a partir de Transfer Learning</li></b></a>
    <a href="#ensem"><b><li>Modelo final: creación de un ensemble</li></b></a>
    <a href="#resultados"><b><li>Comparativa de los resultados obtenidos</li></b></a>
    
    
        
    
</ol>
</section>
<div class="cell markdown">
<h1 id="section"><a id="introduccion"></a></h1>
<h1 id="1-introducción-y-carga-de-librerias">1. Introducción y carga de librerias</h1>
<p>A lo largo de esta práctica, trabajaremos con el conjunto de datos MNIST, se ha utilizado como estándar para probar el rendimiento de diferentes algoritmos de clasificación supervisada en problemas de visión artificial, donde tendremos el objetivo de clasificar imagenes de dígitos manuscritos por su valor.</p>
<p>Por ello, para el desarrollo de esta práctica, en un inicio hemos estudiado a fondo las librerias de <code>tensorflow</code> Una vez hecho esto, hemos elaborado una serie de redes neuronales, que se verán en profundidad en los próximos apartados, de tal forma que ponamos obtener las mejores predicciones posibles de este conjunto de imágenes.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:01.256133Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:01.256734Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:20.409061Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:01.256832Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:20.407866Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install plot<span class="op">-</span>keras<span class="op">-</span>history</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Para ello, comenzamos cargando las librerias que vamos a usar a lo largo del transcuro de la práctica:</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:24.726414Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:24.727429Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:31.167964Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:24.727498Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:31.167010Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plot_keras_history <span class="im">import</span> plot_history</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow.keras <span class="im">as</span> keras</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Antes de comenzar con la práctica es necesario explicar que para acelerar el entrenamiento de las redes neuronales hemos utilizado una entorno <code>Multi-GPU</code> dado que Kaggle nos ofrece la posibilidad de utilizar dos GPUs al mismo tiempo. Decidimos implementar esto dado que nos aceleraba un pequeño porcentaje los entrenamiento de las redes. Para ello utilizamos <code>MirroredStrategy()</code> de tensorflow y activados el acelerador de Kaggle que contiene las dos GPUs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:32.199823Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:32.200330Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:33.292117Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:32.200363Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:33.290970Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>nvidia<span class="op">-</span>smi</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:33.837464Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:33.837781Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:37.884652Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:33.837815Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:37.883608Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>strategy <span class="op">=</span> tf.distribute.MirroredStrategy()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Number of devices: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(strategy.num_replicas_in_sync))</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Fijamos una semilla, aunque esto no eliminará el no determinismo en <code>tensorflow</code> si se utilizan tarjetas gráficas debido a la ejecución en paralelo de determinadas operaciones matemáticas.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:37.886490Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:37.887657Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:37.892539Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:37.887712Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:37.891472Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">27912</span></span></code></pre></div>
</div>
<div class="cell markdown">
<h1 id="section"><a id="visualizacion"></a></h1>
<h1 id="2-visualización-y-estudio-de-las-imágenes-del-conjunto-entrenamiento">2. Visualización y estudio de las imágenes del conjunto entrenamiento</h1>
<p>Comenzamos con la carga del conjunto de datos de la competición, indicando el batch size a usar y el tamaño de las imágenes. Tambien determinamos que en la división del train y validación indicando que este último será de un tamaño del 20% del total de las imágenes facilitadas para el entrenamiento del modelo.</p>
<p>En nuestro caso, tomamos como tamaño de batch 64, lo que implica que, en cada iteracción, se procesaran las imagenes de 64 en 64 de cara a actaulizar los parámetros de nuestra red neuronal. Además, la inferencia se realizará de la misma forma, con 64 imágenes en paralelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:37.893835Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:37.894617Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:07:37.903469Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:37.894656Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:07:37.902842Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>competition <span class="op">=</span> <span class="st">&quot;recognition-2022&quot;</span>  <span class="co"># The unique name of the competition</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>root <span class="op">=</span> os.path.join(<span class="st">&quot;..&quot;</span>, <span class="st">&quot;input&quot;</span>, competition, <span class="st">&quot;</span><span class="sc">{0}</span><span class="st">&quot;</span>)  <span class="co"># Directory with the subsets of the data</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">64</span>  <span class="co"># Size of the batches of data</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>image_size <span class="op">=</span> (<span class="dv">224</span>, <span class="dv">224</span>)  <span class="co"># Size to resize images to after they are read from disk</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;batch_size&quot;</span>: batch_size, <span class="st">&quot;image_size&quot;</span>: image_size, <span class="st">&quot;seed&quot;</span>: seed}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:07:37.905649Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:07:37.906248Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:08:23.422740Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:07:37.906285Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:08:23.421783Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the training dataset from image files in the corresponding directory</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;directory&quot;</span>] <span class="op">=</span> root.<span class="bu">format</span>(<span class="st">&quot;train&quot;</span>)  <span class="co"># Directory where the training dataset is located</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;validation_split&quot;</span>] <span class="op">=</span> <span class="fl">0.2</span>  <span class="co"># Fraction of data to reserve for validation</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;subset&quot;</span>] <span class="op">=</span> <span class="st">&quot;training&quot;</span>  <span class="co"># Subset of the data to return</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;shuffle&quot;</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether to shuffle the data</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>training <span class="op">=</span> keras.utils.image_dataset_from_directory(<span class="op">**</span>arguments)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>De la misma forma, cargamos las imágenes del conjunto de datos destinadas para validación y test.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:08:23.424831Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:08:23.425142Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:08:32.777521Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:08:23.425182Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:08:32.776504Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the validation dataset from image files in the corresponding directory</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;subset&quot;</span>] <span class="op">=</span> <span class="st">&quot;validation&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>validation <span class="op">=</span> keras.utils.image_dataset_from_directory(<span class="op">**</span>arguments)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:08:32.778898Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:08:32.779487Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:05.729972Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:08:32.779526Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:05.728821Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the training dataset from image files in the corresponding directory</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;directory&quot;</span>] <span class="op">=</span> root.<span class="bu">format</span>(<span class="st">&quot;test&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;validation_split&quot;</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;subset&quot;</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;shuffle&quot;</span>] <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to shuffle the data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>testing <span class="op">=</span> keras.utils.image_dataset_from_directory(<span class="op">**</span>arguments)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Para conseguir que nuestras redes neuronales sean más robustas y generalicen mejor realizamos <code>Data Augmentation</code>. Para aplicar esto a nuestro conjunto de entrenamiento realizamos un mapeo utilizando unas capas predeterminadas para realizar rotaciones, traslaciones o zoom. Decidimos aplicar un conjunto de capas dado que es más fácil tratar con un Dataset de Tensorflow. A continuación, veremos que capas hemos utilizado:</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:05.732393Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:05.733294Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:05.766716Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:05.733326Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:05.765834Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>augmentation_layers <span class="op">=</span> tf.keras.Sequential([</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                        tf.keras.layers.RandomTranslation(<span class="fl">0.1</span>,<span class="fl">0.1</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                        tf.keras.layers.RandomRotation(factor<span class="op">=</span>(<span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>)),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                        tf.keras.layers.RandomZoom(<span class="fl">0.1</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                        ])</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Lo que hacemos es realizar una pequeña transalación, una pequeña rotación y un pequeño zoom, todo de manera aleatoria. Una vez tenemos la alteración que vamos a aplicar a nuestro conjunto de entrenamiento podemos realizarlo:</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:05.768005Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:05.768295Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:06.087136Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:05.768328Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:06.086237Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> training.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: (augmentation_layers(x), y))</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, concatenamos el conjunto de datos de entrenamiento original y el alterado.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:06.088972Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:06.089308Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:06.104160Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:06.089343Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:06.102962Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>training_aug <span class="op">=</span> training.concatenate(train)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>training_aug.shuffle(<span class="dv">64</span>)</span></code></pre></div>
</div>
<section id="22-visualización-de-las-imágenes" class="cell markdown">
<h3>2.2 Visualización de las imágenes</h3>
<p>Ahora, pasamos a realizar una visualización de las imagenes del conjunto de entrenamiento, cargando 9 imágenes de este con su respectiva etiqueta para así obtener algo de información de este conjunto</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:06.105817Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:06.106131Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:09.141431Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:06.106166Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:09.140397Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>num <span class="op">=</span> <span class="va">None</span>  <span class="co"># A unique identifier for the figure</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">10</span>)  <span class="co"># Width and height in inches</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>plt.figure(num, figsize)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataset with one element</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>tensors <span class="op">=</span> training_aug.take(<span class="dv">1</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the class names from the training dataset</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> training.class_names</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> np.array(classes)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> images, labels <span class="kw">in</span> tensors:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">9</span>):</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transform the tensor to an array</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> images[i]</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> np.array(image).astype(np.uint8)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the class name of the image</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> labels[i]</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> classes[label]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Visualize the image</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        plt.imshow(image)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        plt.title(label)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        plt.axis(<span class="st">&quot;off&quot;</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Podemos apreciar cómo hay imágenes alteradas en cuanto a rotación, translación o zoom.</p>
</div>
<div class="cell markdown">
<h1 id="section"><a id="prep"></a></h1>
<h1 id="3-preprocesamiento-de-las-imágenes">3. Preprocesamiento de las imágenes</h1>
<p>Primero, antes de crear los modelos, generamos una secuencia de capas para el preprocesamiento, que usaremos para adaptar nuestra entrada a estos. Esta está compuesta de las sigueintes capas: <ul> <li>Capa de Rescaling, que convertiran nuestras imagenes en escala <span class="math inline">[0,1]</span>, haciendo el entrenamiento más rápido</li> <li>Capa de GaussianNoise, que nos servirá para introducirle ruido a las imágenes y que, a la hora de entrenar, esta red generalice, de tal forma que no se sobreajuste al conjunto de entrenamiento.</li> </ul></p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:41.866353Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:41.867025Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:41.877093Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:41.867063Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:41.875885Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>preprocessing_layers <span class="op">=</span> tf.keras.Sequential([</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                        tf.keras.layers.Rescaling(<span class="fl">1.</span><span class="op">/</span><span class="dv">255</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                        tf.keras.layers.GaussianNoise(<span class="fl">0.85</span>)]    </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                        )</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:42.608986Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:42.609624Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:42.677742Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:42.609663Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:42.676852Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>training_preprocessed <span class="op">=</span> training_aug.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: (preprocessing_layers(x), y))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>validation_preprocessed <span class="op">=</span> validation.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: (preprocessing_layers(x), y))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>testing_preprocessed <span class="op">=</span> testing.<span class="bu">map</span>(<span class="kw">lambda</span> x, y: (preprocessing_layers(x), y))</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez tenemos los conjuntos de datos preparados tendremos que activar una opción de los Dataset de Tensorflow para poder utilizar la ejecución <code>Multi-GPU</code>.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:44.575147Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:44.575481Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:44.583539Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:44.575515Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:44.582453Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>options <span class="op">=</span> tf.data.Options()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>options.experimental_distribute.auto_shard_policy <span class="op">=</span> tf.data.experimental.AutoShardPolicy.FILE</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>training_preprocessed <span class="op">=</span> training_preprocessed.with_options(options)  <span class="co"># use this as input for your model</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>validation_preprocessed <span class="op">=</span> validation_preprocessed.with_options(options)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>testing_preprocessed <span class="op">=</span> testing_preprocessed.with_options(options)</span></code></pre></div>
</div>
<div class="cell markdown">
<h1 id="section"><a id="neuronal"></a></h1>
<h1 id="4-elaboración-de-una-red-neuronal-inicial">4. Elaboración de una red neuronal inicial</h1>
<p>Una vez estudiado el conjunto de datos, procedemos a realizar una pequeña red neuronal como primera aproximación al problema. A continuación, veremos las capas empleadas para generar nuestro primer modelo y por último, estudiaremos de forma breve los resultados que obtiene esta primera aproximación</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:46.276371Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:46.277047Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:46.282531Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:46.277086Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:46.281041Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:47.174073Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:47.174343Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:47.178731Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:47.174370Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:47.177714Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the models</span></span></code></pre></div>
</div>
<section id="formalización-de-las-imágenes-de-entrada" class="cell markdown">
<h4>Formalización de las imágenes de entrada</h4>
<p>Para la primera capa de nuestra red, utilizamos una capa de reescalado que modifica nuestras imagenes de entrada, que, como se ha visto antes, estan formadas por tres canales en escala 0-255, pasando estos a escala 0-1, que nos ayidará a mejorar los tiempos de entrenamiento de la red. Para ello empleamos una capa de <code>Rescaling</code></p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:48.512600Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:48.512927Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:48.519169Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:48.512956Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:48.517987Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>scale <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> <span class="dv">255</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>input_shape <span class="op">=</span> (<span class="op">*</span>image_size, <span class="dv">3</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;scale&quot;</span>: scale, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Rescaling(<span class="op">**</span>arguments)  <span class="co"># A preprocessing layer which rescales input values to a new range</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>layers <span class="op">=</span> [layer] <span class="co"># The list of layers to add to the model</span></span></code></pre></div>
</div>
<section id="capa-flaten" class="cell markdown">
<h4>Capa Flaten</h4>
<p>Tras la anterior capa, usamos una capa <code>Flatten</code>, que nos permite aplanar la entrada sin afectar al tamaño del batch definido anteriormente.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:49.428656Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:49.428947Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:49.435613Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:49.428976Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:49.434190Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>data_format <span class="op">=</span> <span class="st">&quot;channels_last&quot;</span>  <span class="co"># The ordering of the dimensions in the inputs</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)  <span class="co"># A layer which flattens the input without affecting to the batch size</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>layers.append(layer)</span></code></pre></div>
</div>
<section id="capa-densa" class="cell markdown">
<h4>Capa Densa</h4>
<p>Añadimos una capa oculta para conseguir mejores resultados en nuestro modelo y tras ella, una de salida para realizar la clasificación.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:50.084933Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:50.085697Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:50.101138Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:50.085731Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:50.100288Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>units <span class="op">=</span> <span class="dv">64</span>  <span class="co"># Dimensionality of the output space</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span>  <span class="co"># Activation function</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation}</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)  <span class="co"># Regular connected neural network layer</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>layers.append(layer)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:50.318553Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:50.322645Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:50.332726Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:50.322685Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:50.331735Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;units&quot;</span>] <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>arguments[<span class="st">&quot;activation&quot;</span>] <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>layers.append(layer)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, creamos el modelo con las capas correspondientes.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:50.793604Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:50.794203Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:50.834143Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:50.794251Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:50.833115Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Group a linear stack of layers into a model</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Neural network&quot;</span>] <span class="op">=</span> keras.models.Sequential(layers)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Obtenemos un resumen con las capas empleadas y el número de parámetros a entrenar por la red, que asciende hasta una crifra mayor a los 9 millones</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:51.266630Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:51.266886Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:51.276651Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:51.266911Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:51.275719Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print a string summary of the network</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>length <span class="op">=</span> <span class="dv">79</span>  <span class="co"># Total length of printed lines</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Neural network&quot;</span>].summary(length)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Configuramos el learning-rate e indicamos la accuracy como metrica del score para este modelo que se utilizaran en el entrenamiento de este.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T09:09:51.716704Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T09:09:51.717056Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T09:09:51.746973Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T09:09:51.717089Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T09:09:51.745475Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure the model for training</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)  <span class="co"># Cross entropy loss between the labels and predictions</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]  <span class="co"># List of metrics to be evaluated by the model during training and testing</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Neural network&quot;</span>].<span class="bu">compile</span>(optimizer, loss, metrics)</span></code></pre></div>
</div>
<div class="cell markdown">
<h1 id="section"><a id="convolucional"></a></h1>
<h1 id="5-elaboracion-de-una-red-convolucional">5. Elaboracion de una red convolucional</h1>
<p>Además de la red neuronal anterior, como segunda aproximación para la resolución de este problema, generaremos una red convolucional, que en teoría mejoraría los resultados obtenidos en el modelo anterior para el entrenamiento con imágenes.</p>
<p>Para la elaboración de esta red crearemos una función, esto se debe que para aprovechar la ejecución de las dos GPUs debemos crear el modelo bajo la MirroredStrategy.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T17:27:44.911612Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T17:27:44.911957Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T17:27:44.927961Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T17:27:44.911988Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T17:27:44.926853Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_cnn():</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    input_shape <span class="op">=</span> (<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_1 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation, input_shape<span class="op">=</span>input_shape)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    layers <span class="op">=</span> [convolutional_layer_1]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    batch_normalization_1 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_1)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_2 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_2)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    batch_normalization_2 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_2)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    max_pooling_layer_1 <span class="op">=</span> keras.layers.MaxPooling2D(<span class="dv">2</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    layers.append(max_pooling_layer_1)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    dropout_layer_1 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_1)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_3 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&quot;same&quot;</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_3)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    batch_normalization_3 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_3)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_4 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">32</span>, kernel_size <span class="op">=</span> <span class="dv">13</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_4)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    batch_normalization_4 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_4)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_5 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">64</span>, kernel_size <span class="op">=</span> <span class="dv">13</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_5)</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    batch_normalization_5 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_5)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    max_pooling_layer_2 <span class="op">=</span> keras.layers.MaxPooling2D(<span class="dv">2</span>)</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    layers.append(max_pooling_layer_2)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    dropout_layer_2 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_2)</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_6 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">128</span>, kernel_size <span class="op">=</span> <span class="dv">13</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_6)</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    batch_normalization_6 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_6)</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    dropout_layer_3 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_3)</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    flatten_layer <span class="op">=</span> keras.layers.Flatten(data_format<span class="op">=</span>data_format)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    layers.append(flatten_layer)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>    hidden_layer_1 <span class="op">=</span> keras.layers.Dense(<span class="dv">256</span>, activation<span class="op">=</span>activation)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>    layers.append(hidden_layer_1)</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>    dropout_layer_4 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.4</span>)</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_4)</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    output_layer <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    layers.append(output_layer)</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Sequential(layers)</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Como se puede apreciar hemos creado la función que nos devuelve el modelo de una red convolucional, esta red está compuesta por unos filtros grandes para obligar a la red a generalizar mejor y obligar a que saque patrones diferenciales. Además, añadimos capas Dropout, BatchNormalization y MaxPooling por todo el modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T17:27:45.343652Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T17:27:45.343965Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T17:27:45.661667Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T17:27:45.343996Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T17:27:45.660690Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;cnn&quot;</span>] <span class="op">=</span> build_cnn()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Para poder utilizar las dos GPUs debemos crear el modelo bajo la función <code>scope()</code> de MirroredStrategy, por eso la creación del modelo a partir de una función que hemos creado. Además definimos un callback de parada rápida que permite detener cuando no existan cambios significativos en la mejora de nuestra métrica de rendimiento, además de evitar el sobreajuste.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T14:17:59.690516Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T14:17:59.690920Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T14:17:59.696469Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T14:17:59.690956Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T14:17:59.695281Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>early_stopping <span class="op">=</span> tf.keras.callbacks.EarlyStopping(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    monitor<span class="op">=</span><span class="st">&quot;val_loss&quot;</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    min_delta<span class="op">=</span><span class="fl">0.0002</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    patience<span class="op">=</span><span class="dv">3</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Destacar que este callback nunca se llegará a aplicar dado que limitaremos las epochs de entrenamiento dado el largo periodo de tiempo que lleva entrenar los modelos. A continuación, realizaremos un entrenamiento de 10 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T17:27:50.540526Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T17:27:50.540848Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T17:27:50.547141Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T17:27:50.540876Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T17:27:50.545885Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T17:27:51.177774Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T17:27:51.180094Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T19:15:28.984426Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T17:27:51.180132Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T19:15:28.983449Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Durante el entrenamiento la mejor época resultó en un <code>0.9886</code> sobre el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T19:15:28.988105Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T19:15:28.988370Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T19:15:28.995682Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T19:15:28.988397Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T19:15:28.994652Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed,<span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez hemos entrenado nuestro modelo y lo hemos validado podemos entrenarlo con el conjunto de validación. Esto lo hacemos para aprovechar todo el conjunto de entrenamiento antes de "la puesta en producción"(en nuestro caso la predicción del test). Destacar que en esta libreta no se entrenará ningún modelo para acelerar la ejecución de la misma. Cada modelo ha sido entrenado cómo aparece comentado y posteriormente guardado.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T19:15:28.997246Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T19:15:28.998224Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T19:19:39.025626Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T19:15:28.998259Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T19:19:39.024682Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez lo hemos entrenado guardamos el modelo para usarlo posteriormente.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T19:24:32.464309Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T19:24:32.464983Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T19:24:33.343549Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T19:24:32.465019Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T19:24:33.341674Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn&quot;].save(&quot;cnn_modelo.h5&quot;)</span></span></code></pre></div>
</div>
<section id="elaboración-de-una-segunda-red-convolucional" class="cell markdown">
<h3>Elaboración de una segunda red convolucional</h3>
<p>Dado el buen resultado que hemos obtenido a la hora de crear una red convolucional crearemos una segunda, pero en este caso aplicaremos unos tamaños de filtros más pequeños y eliminaremos el Dropout. Evaluaremos así cómo funciona esta red creada manualmente antes de pasar a las redes de Transfer Learning. La creación de esta red es igual que la anterior, mediante una función que hemos creado.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T14:19:13.151670Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T14:19:13.152017Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T14:19:13.171887Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T14:19:13.152048Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T14:19:13.170949Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_cnn_small():</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    input_shape <span class="op">=</span> (<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_1 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">7</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation, input_shape<span class="op">=</span>input_shape)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    layers <span class="op">=</span> [convolutional_layer_1]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    batch_normalization_1 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_1)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_2 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_2)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    batch_normalization_2 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_2)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_3 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&quot;same&quot;</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_3)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    batch_normalization_3 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_3)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_4 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">32</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_4)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    batch_normalization_4 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_4)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_5 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">32</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_5)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    batch_normalization_5 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_5)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_6 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">64</span>, kernel_size <span class="op">=</span> <span class="dv">5</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_6)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    batch_normalization_6 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_6)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_7 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">128</span>, kernel_size <span class="op">=</span> <span class="dv">5</span>, strides<span class="op">=</span><span class="dv">3</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_7)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    batch_normalization_7 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_7)</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_8 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">128</span>, kernel_size <span class="op">=</span> <span class="dv">3</span>, strides<span class="op">=</span><span class="dv">3</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_8)</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    batch_normalization_8 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_8)</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    dropout_layer_1 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_1)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    flatten_layer <span class="op">=</span> keras.layers.Flatten(data_format<span class="op">=</span>data_format)</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    layers.append(flatten_layer)</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    hidden_layer_1 <span class="op">=</span> keras.layers.Dense(<span class="dv">256</span>, activation<span class="op">=</span>activation)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    layers.append(hidden_layer_1)</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>    dropout_layer_2 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.4</span>)</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_2)</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>    output_layer <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    layers.append(output_layer)</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Sequential(layers)</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T14:19:13.966673Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T14:19:13.967018Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T14:19:14.339038Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T14:19:13.967050Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T14:19:14.338066Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;cnn_2&quot;</span>] <span class="op">=</span> build_cnn_small()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso entrenaremos 5 epochs el modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T14:19:16.774808Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T14:19:16.775167Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T14:19:16.781468Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T14:19:16.775214Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T14:19:16.780393Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T14:19:18.119126Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T14:19:18.119834Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:22:07.274688Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T14:19:18.119872Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:22:07.273724Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn_2&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>El resultado de esta red convolucional es de <code>0.9745</code> sobre el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:23:04.930502Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:23:04.930879Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:23:04.937101Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:23:04.930912Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:23:04.936011Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed,<span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso también entrenaremos con el conjunto de validación cómo hemos comentado anteriormente.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:23:05.721571Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:23:05.721879Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:31:16.106125Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:23:05.721910Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:31:16.105141Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn_2&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, guardaremos el modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:31:16.108502Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:31:16.109037Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:31:16.647776Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:31:16.109085Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:31:16.646604Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;cnn_2&quot;].save(&quot;cnn_2.h5&quot;)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Concluir que el resultado obtenido de las dos redes convolucionales son muy buenos, tendremos que compararlos con los siguientes modelos de Transfer Learning y a la hora de la subida del test.</p>
</div>
<div class="cell markdown">
<h1 id="section"><a id="ensemble"></a></h1>
<h1 id="6-creacion-y-diseño-del-modelo-final">6. Creacion y diseño del modelo final</h1>
<p>Además de las redes neuronales vista anteriormente, hemos elaborado un modelo conformado por un ensemble de redes convolucionales ya entrenadadas, usando por lo tanto técnicas de <strong>transfer lerning</strong>. Estos, además de contener una gran cantidad de capas que nos permiten obtener mejores resultados que con redes convolucionales propias, como ya se verá posteriormente, han sido entrenados, algo que nos ahorrará las grandes cantidades de tiempo necesarias para entrenar una red de esas características.</p>
</div>
<section id="primer-modelo-de-transfer-learning-vgg19" class="cell markdown">
<h4>Primer modelo de Transfer Learning: VGG19</h4>
<p>Para conformar nuestro modelo, como ya se ha indicado anteriormente, haremos uso de modelos obtenidos por Transfer Learning. El primero de ellos es el <strong>VGG19</strong>. Tanto con este como con el resto de modelos de Transfer Learning, el procedimiento seguido será el mismo. Además, para adaptar las imagenes de entrada al modelo añadimos diversas capas como la <code>Flatten</code> o la <code>GaussianNoise</code>, esta última usada para evitar el sobreajuste al conjunto de entrenamiento, añadiendo ruido entre las dos últimas capas.</p>
</section>
<div class="cell code">
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_vgg19():</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate the model</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="st">&quot;imagenet&quot;</span>  <span class="co"># The weights to use for the network</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    include_top <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include the layers at the top of the network</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;weights&quot;</span>: weights, <span class="st">&quot;include_top&quot;</span>: include_top, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> tf.keras.applications.VGG19(<span class="op">**</span>arguments)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    modelo.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> modelo.output</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)(x)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicamos algo de ruido Gaussiano entre las dos últimas capas dense para obligar </span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a nuestro modelo a generalizar mejor.</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> tf.keras.layers.GaussianNoise(<span class="fl">0.3</span>)(x)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> modelo.<span class="bu">input</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;inputs&quot;</span>: inputs, <span class="st">&quot;outputs&quot;</span>: outputs}</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Model(<span class="op">**</span>arguments)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    modelo.summary(length)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Para poder utilizar las dos GPUs que nos ofrece Kaggle deberemos crear el modelo bajo la función scope() del MirroredStrategy. Es por ello que hemos creado el modelo a partir de una función como se puede apreciar.</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;VGG19&quot;</span>] <span class="op">=</span> build_vgg19()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;VGG19&quot;</span>].summary()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, para preparar al modelo para el entrenamiento, definimos el número de épocas de este y pasamos por parámetro los datos ya preprocesados. Pero destacar que este callback nunca se llegará a aplicar dado que limitaremos las epochs de entrenamiento dado el largo periodo de tiempo que lleva entrenar los modelos.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T09:14:39.008168Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T09:14:39.008504Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T09:14:39.013637Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T09:14:39.008534Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T09:14:39.012608Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Entrenamos 5 epochs con los conjunto de entranamiento preprocesado. Destacar que en esta libreta no se entrenará ningún modelo para acelerar la ejecución de la misma. Cada modelo ha sido entrenado cómo aparece comentado y posteriormente guardado.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T09:14:39.751802Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T09:14:39.752153Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T10:27:46.144331Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T09:14:39.752185Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T10:27:46.143003Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;VGG19&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>La mejor época de este modelo resulto en<code>0.9870</code> de accuracy en el conjunto de validación. Dado que ya tenemos un valor para definir los mejores modelos procedemos a entrenar también con el conjunto de validación, dado que podemos aprovechar todo el conjunto de entrenamiento y validación para la posterior predicción sobre el test.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T10:27:50.102729Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T10:27:50.103068Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T10:27:50.108014Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T10:27:50.103106Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T10:27:50.107014Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T10:27:50.892891Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T10:27:50.893217Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T10:39:15.847527Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T10:27:50.893248Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T10:39:15.846603Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;VGG19&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez tenemos ya nuestro modelo entrenado completamente procedemos a guardarlo, pudiendo cargarlo cuándo queramos.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T10:43:32.847520Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T10:43:32.847837Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T10:43:33.073381Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T10:43:32.847869Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T10:43:33.072354Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;VGG19&quot;].save(&quot;vgg19_model.h5&quot;)</span></span></code></pre></div>
</div>
<section id="otro-modelo-que-usaremos-de-transfer-learning-xception" class="cell markdown">
<h4>Otro modelo que usaremos de Transfer Learning: Xception</h4>
<p>En este caso se trata de <strong>Xception</strong> y realizaremos el mismo procedimiento que hemos visto para VGG19. Crearemos una función para crear el modelo bajo la MirroredStrategy y así aprovechar las dos GPUs que nos ofrece Kaggle.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T11:04:36.183501Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T11:04:36.183828Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T11:04:36.193119Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T11:04:36.183859Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T11:04:36.192122Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_xception():</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate the model</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="st">&quot;imagenet&quot;</span>  <span class="co"># The weights to use for the network</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    include_top <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include the layers at the top of the network</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;weights&quot;</span>: weights, <span class="st">&quot;include_top&quot;</span>: include_top, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> tf.keras.applications.Xception(<span class="op">**</span>arguments)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    modelo.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> modelo.output</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)(x)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicamos algo de ruido Gaussiano entre las dos últimas capas dense para obligar </span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a nuestro modelo a generalizar mejor.</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> tf.keras.layers.GaussianNoise(<span class="fl">0.3</span>)(x)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> modelo.<span class="bu">input</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;inputs&quot;</span>: inputs, <span class="st">&quot;outputs&quot;</span>: outputs}</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Model(<span class="op">**</span>arguments)</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    modelo.summary(length)</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell code" data-collapsed="true" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T11:04:54.501344Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T11:04:54.501666Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T11:04:57.440458Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T11:04:54.501698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T11:04:57.438730Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-trusted="true">
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;Xception&quot;</span>] <span class="op">=</span> build_xception()</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Xception&quot;</span>].summary()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que con VGG19 se entrenará el modelo durante 5 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T11:31:03.955228Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T11:31:03.955711Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T11:31:03.961387Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T11:31:03.955743Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T11:31:03.960137Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T11:31:06.053329Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T11:31:06.053668Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:04:31.663070Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T11:31:06.053700Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:04:31.662093Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;Xception&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso, durante el entrenamiento la mejor época resultó en un <code>0.9800</code> en el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:04:39.313530Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:04:39.315334Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:04:39.320813Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:04:39.315381Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:04:39.319781Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que antes una vez sabemos el resultado en el conjunto de validación ya podemos entrenar también con el conjunto de validación aprovechando todo el conjunto de entrenamiento.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:04:39.727749Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:04:39.728347Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:08:54.412126Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:04:39.728393Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:08:54.411212Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;Xception&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, procedemos a guardar el modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:11:41.339917Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:11:41.340957Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:11:42.146050Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:11:41.341020Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:11:42.145070Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;Xception&quot;].save(&quot;xception_model.h5&quot;)</span></span></code></pre></div>
</div>
<section id="otro-modelo-que-usaremos-de-transfer-learning-densenet201" class="cell markdown">
<h4>Otro modelo que usaremos de Transfer Learning: DenseNet201</h4>
<p>En este caso utilizaremos <strong>DenseNet201</strong> y realizaremos los mismos pasos que en los anteriores.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:11:50.144136Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:11:50.145012Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:11:50.154849Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:11:50.145051Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:11:50.153697Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_densenet():</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate the model</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="st">&quot;imagenet&quot;</span>  <span class="co"># The weights to use for the network</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    include_top <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include the layers at the top of the network</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;weights&quot;</span>: weights, <span class="st">&quot;include_top&quot;</span>: include_top, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> tf.keras.applications.DenseNet201(<span class="op">**</span>arguments)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    modelo.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> modelo.output</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)(x)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicamos algo de ruido Gaussiano entre las dos últimas capas dense para obligar </span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a nuestro modelo a generalizar mejor.</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> tf.keras.layers.GaussianNoise(<span class="fl">0.3</span>)(x)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> modelo.<span class="bu">input</span></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;inputs&quot;</span>: inputs, <span class="st">&quot;outputs&quot;</span>: outputs}</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Model(<span class="op">**</span>arguments)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    modelo.summary(length)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell code" data-collapsed="true" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:11:52.491870Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:11:52.492201Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:12:02.442079Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:11:52.492232Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:12:02.441105Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-trusted="true">
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;DenseNet201&quot;</span>] <span class="op">=</span> build_densenet()</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;DenseNet201&quot;</span>].summary()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que con los anteriores modelos se entrenará el modelo durante 5 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:12:11.960922Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:12:11.961593Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T12:12:11.966916Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:12:11.961632Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T12:12:11.965892Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T12:12:13.318117Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T12:12:13.318488Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:11:06.787125Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T12:12:13.318523Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:11:06.786114Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;DenseNet201&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso el mejor resultado en el conjunto de validación fue de <code>0.9830</code>.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:11:06.857536Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:11:06.857851Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:11:06.862701Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:11:06.857887Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:11:06.861778Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que antes aprovechamos todo el conjunto de entrenamiento y entrenamos el modelo con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:11:06.864102Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:11:06.864674Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:15:56.959632Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:11:06.864708Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:15:56.958713Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;DenseNet201&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, guardamos el modelo para usarlo posteriormente.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:15:56.961918Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:15:56.962847Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:15:59.186101Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:15:56.962887Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:15:59.185012Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;DenseNet201&quot;].save(&quot;densenet201_model.h5&quot;)</span></span></code></pre></div>
</div>
<section id="otro-modelo-que-usaremos-de-transfer-learning-inceptionv3" class="cell markdown">
<h4>Otro modelo que usaremos de Transfer Learning: InceptionV3</h4>
<p>En este caso se trata de <strong>InceptionV3</strong> y realizamos el mismo procedimiento que con los modelos anteriores.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T10:26:07.445362Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T10:26:07.446310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T10:26:07.457677Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T10:26:07.446348Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T10:26:07.456744Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_inceptionv3():</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate the model</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="st">&quot;imagenet&quot;</span>  <span class="co"># The weights to use for the network</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    include_top <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include the layers at the top of the network</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;weights&quot;</span>: weights, <span class="st">&quot;include_top&quot;</span>: include_top, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> tf.keras.applications.InceptionV3(<span class="op">**</span>arguments)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    modelo.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> modelo.output</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)(x)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicamos algo de ruido Gaussiano entre las dos últimas capas dense para obligar </span></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a nuestro modelo a generalizar mejor.</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> tf.keras.layers.GaussianNoise(<span class="fl">0.3</span>)(x)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> modelo.<span class="bu">input</span></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;inputs&quot;</span>: inputs, <span class="st">&quot;outputs&quot;</span>: outputs}</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Model(<span class="op">**</span>arguments)</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    modelo.summary(length)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell code" data-collapsed="true" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T10:26:09.052377Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T10:26:09.053051Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T10:26:13.212115Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T10:26:09.053087Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T10:26:13.211111Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-trusted="true">
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;InceptionV3&quot;</span>] <span class="op">=</span> build_inceptionv3()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que el resto de modelos entrenaremos durante 5 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T10:28:35.162214Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T10:28:35.162867Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T10:28:35.168374Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T10:28:35.162904Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T10:28:35.167133Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T10:28:35.668590Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T10:28:35.668925Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T11:22:13.546002Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T10:28:35.668956Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T11:22:13.544852Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb65"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionV3&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso la mejor época resultó en un <code>0.9786</code> en el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T11:22:13.548021Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T11:22:13.548462Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T11:22:13.553657Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T11:22:13.548501Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T11:22:13.552600Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb66"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que el resto de modelos entrenamos con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T11:22:13.556060Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T11:22:13.556700Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T11:25:24.127461Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T11:22:13.556736Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T11:25:24.126531Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb67"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionV3&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, guardamos el modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-27T11:25:24.130007Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-27T11:25:24.130986Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-27T11:25:25.028255Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-27T11:25:24.131024Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-27T11:25:25.027208Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb68"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionV3&quot;].save(&quot;inceptionv3_model.h5&quot;)</span></span></code></pre></div>
</div>
<section id="otro-modelo-que-usaremos-de-transfer-learning-inceptionresnetv2" class="cell markdown">
<h4>Otro modelo que usaremos de Transfer Learning: InceptionResNetV2</h4>
<p>En este caso se trata de <strong>InceptionResNetV2</strong> y realizamos el mismo procedimiento que con los modelos anteriores</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:19:24.634828Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:19:24.635171Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:19:24.645220Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:19:24.635204Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:19:24.644176Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb69"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_inceptionresnet():</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Instantiate the model</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> <span class="st">&quot;imagenet&quot;</span>  <span class="co"># The weights to use for the network</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    include_top <span class="op">=</span> <span class="va">False</span>  <span class="co"># Whether to include the layers at the top of the network</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;weights&quot;</span>: weights, <span class="st">&quot;include_top&quot;</span>: include_top, <span class="st">&quot;input_shape&quot;</span>: input_shape}</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> tf.keras.applications.InceptionResNetV2(<span class="op">**</span>arguments)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    modelo.trainable <span class="op">=</span> <span class="va">False</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> modelo.output</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;data_format&quot;</span>: data_format}</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Flatten(<span class="op">**</span>arguments)(x)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicamos algo de ruido Gaussiano entre las dos últimas capas dense para obligar </span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a nuestro modelo a generalizar mejor.</span></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> tf.keras.layers.GaussianNoise(<span class="fl">0.3</span>)(x)</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>    units <span class="op">=</span> <span class="bu">len</span>(classes)</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;softmax&quot;</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;units&quot;</span>: units, <span class="st">&quot;activation&quot;</span>: activation} </span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> keras.layers.Dense(<span class="op">**</span>arguments)(x)</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> modelo.<span class="bu">input</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>    arguments <span class="op">=</span> {<span class="st">&quot;inputs&quot;</span>: inputs, <span class="st">&quot;outputs&quot;</span>: outputs}</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Model(<span class="op">**</span>arguments)</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    modelo.summary(length)</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell code" data-collapsed="true" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:19:25.518720Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:19:25.519006Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:19:37.898554Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:19:25.519035Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:19:37.897434Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-trusted="true">
<div class="sourceCode" id="cb70"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">&quot;InceptionResNetV2&quot;</span>] <span class="op">=</span> build_inceptionresnet()</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;InceptionResNetV2&quot;</span>].summary()</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que el resto de modelos entrenaremos durante 5 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:19:44.529761Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:19:44.530769Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T13:19:44.538704Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:19:44.530824Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T13:19:44.535707Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb71"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T13:19:45.544931Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T13:19:45.545450Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T14:22:03.208934Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T13:19:45.545490Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T14:22:03.208005Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb72"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionResNetV2&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>En este caso la mejor época resultó en un <code>0.9835</code> sobre el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T14:22:03.210932Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T14:22:03.211203Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T14:22:03.220542Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T14:22:03.211230Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T14:22:03.219429Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb73"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que el resto una vez validado el modelo entrenamos también con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T14:22:03.223757Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T14:22:03.224304Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T14:27:45.689261Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T14:22:03.224348Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T14:27:45.688241Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb74"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionResNetV2&quot;].fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, guardamos nuestro modelo.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-26T14:27:45.691506Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-26T14:27:45.691850Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-26T14:27:47.692383Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-26T14:27:45.691898Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-26T14:27:47.691377Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb75"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">#models[&quot;InceptionResNetV2&quot;].save(&quot;inceptionresnetv2_model.h5&quot;)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<h1 id="section"><a id="esem"></a></h1>
<h1 id="7-generación-de-nuestro-ensemble">7. Generación de nuestro ensemble</h1>
<p>El último paso que nos queda es realizar las predicciones del test. Para ello elaboraremos dos ensembles diferentes, uno en el que sumaremos todas las predicciones de los modelos comentados y se escogerá el número con mayor suma de los 10; y un segundo que será un ensemble dónde las salidas de los diferentes modelos derivan en una red neuronal que proporciona una salida.</p>
</div>
<div class="cell markdown">
<p>Lo primero que hacemos es obtener los índices de cada imagen.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:36:44.396975Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:36:44.397337Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:36:44.502383Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:36:44.397370Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:36:44.501285Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb76"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the indices for sorting the predictions</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> testing.file_paths</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: os.path.basename(identifier), identifiers)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: os.path.splitext(identifier), identifiers)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">list</span>(identifiers)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>identifiers, _ <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>identifiers)</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: identifier.replace(<span class="st">&quot;img_&quot;</span>, <span class="st">&quot;&quot;</span>), identifiers)</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: <span class="bu">int</span>(identifier), identifiers)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">list</span>(identifiers)</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> np.array(identifiers)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> np.argsort(identifiers)</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> identifiers[indices]</span></code></pre></div>
</div>
<div class="cell markdown">
<p>A partir de los modelos entrenados previamente, serán cargados y se realizará la inferencia de cada imagen del conjunto de test y obtenemos cual es la clasificación mas probable para cada una de estas instancias, todo ello mediante la media de los resultados de cada uno de los 7 modelos entrenados.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:36:45.852565Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:36:45.852921Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:37:17.048138Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:36:45.852953Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:37:17.046990Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb77"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;cnn&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/cnn_model.h5&#39;</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;cnn2&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/cnn_2.h5&#39;</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;VGG19&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/vgg19_model.h5&#39;</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Xception&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/xception_model.h5&#39;</span>)</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;DenseNet201&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/densenet201_model.h5&#39;</span>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;InceptionV3&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/inceptionv3_model.h5&#39;</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;InceptionResNetV2&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/inceptionresnetv2_model.h5&#39;</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>La primera subida que probaremos será juntando únicamente los modelos de redes convolucionales que hemos creado manualmente. <strong>Destacar que de momento las primeras subidas estarán comentadas para acelerar la ejecución de la libreta, posteriormente se ejecutarán las subidas finales.</strong></p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:37:19.788543Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:37:19.789650Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:40:16.075161Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:37:19.789698Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:40:16.073765Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb78"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">#prob_a = models[&quot;cnn&quot;].predict(testing_preprocessed)</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co">#prob_b = models[&quot;cnn2&quot;].predict(testing_preprocessed)</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">#probabilities = np.add(prob_a,prob_b)</span></span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:40:16.081128Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:40:16.083688Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:40:16.164728Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:40:16.083753Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:40:16.163754Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb79"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;predictions = defaultdict(None)  # Dictionary with the predictions</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co">axis = -1</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co">labels = np.argmax(probabilities, axis)</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="co">labels = classes[labels]</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="co">labels = labels[indices]</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="co">predictions[&quot;esemble&quot;] = np.argmax(labels)</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co">data = {&quot;ImageId&quot;: identifiers, &quot;Label&quot;: labels}</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="co">submission = pd.DataFrame(data).set_index(&quot;ImageId&quot;)</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="co">path = &quot;cnn_cnn2_models.csv&quot;</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="co">submission.to_csv(path, )&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>La subida ha resultado en un public score de: <code>0.96142</code></p>
<h4 id="los-4-mejores-modelos">Los 4 mejores modelos</h4>
<p>Lo siguiente que probaremos será subiendo los 4 mejores modelos obtenidos en la validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:40:16.166553Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:40:16.167222Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:49:11.571862Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:40:16.167261Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:49:11.570600Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb80"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;prob_a = models[&quot;cnn&quot;].predict(testing_preprocessed)</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">prob_b = models[&quot;VGG19&quot;].predict(testing_preprocessed)</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(prob_a,prob_b)</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">prob_c = models[&quot;DenseNet201&quot;].predict(testing_preprocessed)</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(probabilities,prob_c)</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="co">prob_d = models[&quot;InceptionResNetV2&quot;].predict(testing_preprocessed)</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(probabilities,prob_d)&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:49:11.576728Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:49:11.577044Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:49:11.619092Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:49:11.577074Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:49:11.618130Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb81"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;predictions = defaultdict(None)  # Dictionary with the predictions</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">axis = -1</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co">labels = np.argmax(probabilities, axis)</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">labels = classes[labels]</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">labels = labels[indices]</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">predictions[&quot;esemble&quot;] = np.argmax(labels)</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co">data = {&quot;ImageId&quot;: identifiers, &quot;Label&quot;: labels}</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co">submission = pd.DataFrame(data).set_index(&quot;ImageId&quot;)</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="co">path = &quot;4_best_models.csv&quot;</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="co">submission.to_csv(path, )&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Si juntamos los 4 mejores modelos obtenemos un public score de: <code>0.99114</code></p>
<h4 id="todos-los-modelos">Todos los modelos</h4>
<p>Por último, juntaremos todos los modelos.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:49:11.620337Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:49:11.621286Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:50:13.419916Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:49:11.621321Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:50:13.417423Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb82"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;prob_e = models[&quot;Xception&quot;].predict(testing_preprocessed)</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(probabilities,prob_e)</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co">prob_f = models[&quot;InceptionV3&quot;].predict(testing_preprocessed)</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(probabilities,prob_f)</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">prob_g = models[&quot;cnn2&quot;].predict(testing_preprocessed)</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="co">probabilities = np.add(probabilities, prob_g)&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:50:14.454529Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:50:14.454767Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:50:14.455097Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:50:14.454791Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb83"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;predictions = defaultdict(None)  # Dictionary with the predictions</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="co">axis = -1</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">labels = np.argmax(probabilities, axis)</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">labels = classes[labels]</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">labels = labels[indices]</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">predictions[&quot;esemble&quot;] = np.argmax(labels)</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co">data = {&quot;ImageId&quot;: identifiers, &quot;Label&quot;: labels}</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">submission = pd.DataFrame(data).set_index(&quot;ImageId&quot;)</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">path = &quot;all_models.csv&quot;</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="co">submission.to_csv(path, )&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Si juntamos todos los modelos obtenemos un public score de: <code>0.99228</code></p>
<p>Por lo tanto, el mejor resultado obtenido es el de juntar todos los modelos.</p>
</div>
<section id="creación-de-un-ensemble-a-partir-de-una-red-neuronal" class="cell markdown">
<h3>Creación de un ensemble a partir de una red neuronal</h3>
<p>La segunda forma es elaborando un ensemble que conecte todas las salidas en un red neuronal. Lo podemos ver en la siguiente imagen.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-29T16:58:24.332821Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-29T16:58:24.333310Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-29T16:58:24.396966Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-29T16:58:24.333429Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-29T16:58:24.396032Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb84"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>Image(<span class="st">&#39;../input/models/ensemble_learning.png&#39;</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>La idea que hay detrás es la siguiente: cada modelo realiza sus predicciones sobre el Input(nuestro conjunto de test) y esta conectado con Combination(que será nuestra capa oculta Dense y Dropout), por último, se conecta con Output(que será nuestra última capa Dense que muestre la salida).</p>
</div>
<div class="cell markdown">
<p>Por lo tanto, empezamos creando las capas de entrada que en este caso es solamente una capa Input.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:18:00.974695Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:18:00.975037Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:18:00.983239Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:18:00.975069Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:18:00.982121Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb85"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>input_layer <span class="op">=</span> tf.keras.layers.Input((<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>))</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Creamos las capas encargadas de combinar los resultados de los diferentes modelos y proporcionar un resultado final. Estará compuesta por una capa Concatenate, para concatenar todos los resultados de los diferentes modelos, una vez los tenemos pasará por una capa Dense de 128, una capa Dropout de 0.5 forzando a la red a generalizar mejor, y por último, una capa Dense de 10 para proporcionar el resultado final.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:18:02.619205Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:18:02.619591Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:18:02.629184Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:18:02.619627Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:18:02.628039Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb86"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>output_layers <span class="op">=</span> [tf.keras.layers.Concatenate(),tf.keras.layers.Dense(<span class="dv">128</span>,<span class="st">&quot;relu&quot;</span>),tf.keras.layers.Dropout(<span class="fl">0.5</span>),tf.keras.layers.Dense(<span class="dv">10</span>,<span class="st">&quot;softmax&quot;</span>)]</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez tenemos claras las capas de entrada y salida almacenamos la dirección de los modelos en una lista.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:57:31.538541Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:57:31.538898Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:57:31.543741Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:57:31.538930Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:57:31.542645Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb87"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [<span class="st">&#39;../input/models/cnn_model.h5&#39;</span>,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/cnn_2.h5&#39;</span>,</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/vgg19_model.h5&#39;</span>,</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/xception_model.h5&#39;</span>,</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/densenet201_model.h5&#39;</span>,</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/inceptionresnetv2_model.h5&#39;</span>,</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/inceptionv3_model.h5&#39;</span>]</span></code></pre></div>
</div>
<div class="cell markdown">
<p>A continuación, crearemos las funciones necesarias para crear nuestro ensemble. Necesitaremos una para cargar todos los modelos, otra para congelar los pesos de los modelos ya entrenados y una última para crear el ensemble final.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:18:05.252175Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:18:05.252521Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:18:05.258143Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:18:05.252554Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:18:05.256948Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb88"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_models(models):</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    loaded_models <span class="op">=</span> []</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i,model <span class="kw">in</span> <span class="bu">enumerate</span>(models):</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> keras.models.load_model(model)</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>        m._name <span class="op">=</span> <span class="ss">f&quot;model_</span><span class="sc">{i}</span><span class="ss">&quot;</span> </span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>        loaded_models.append(m)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loaded_models</span></code></pre></div>
</div>
<div class="cell markdown">
<p>El método creado para cargar los modelos es muy sencillo, simplemente va recorriendo la lista de las direcciones y los va almacenando en una lista que se devuelve.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:18:06.177013Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:18:06.177667Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:18:06.182907Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:18:06.177705Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:18:06.181784Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb89"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> freeze_layers(models):</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> model <span class="kw">in</span> models:</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>        layers <span class="op">=</span> model.layers</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layer <span class="kw">in</span> layers:</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>            layer.trainable <span class="op">=</span> <span class="va">False</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Para congelar los pesos de las capas tendremos que recorrer cada capa y establecer el atributo trainable a False.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:18:09.228391Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:18:09.229110Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:18:09.236406Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:18:09.229158Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:18:09.235220Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb90"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_ensemble(models):</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    models <span class="op">=</span> load_models(models)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    freeze_layers(models)</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> [model(input_layer) <span class="cf">for</span> model <span class="kw">in</span> models]</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> layer <span class="kw">in</span> output_layers:</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> layer(outputs)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    ensemble <span class="op">=</span> tf.keras.Model(input_layer, outputs)</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>    ensemble.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ensemble</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Por último, para crear el ensemble cargaremos los modelos y congelaremos sus pesos. Posteriormente estableceremos a cada modelo la capa de entrada, en el caso de las salidas estableceremos para cada capa la salida de la capa anterior. Por lo tanto, tendremos las capas de entrada por un lado y las capas de salida por otro lado, haciendo posible crear nuestro ensemble.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:57:34.684362Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:57:34.685004Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:58:13.418816Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:57:34.685040Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:58:13.417738Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb91"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    ensemble <span class="op">=</span> create_ensemble(models)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:58:13.420624Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:58:13.420952Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:58:14.751375Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:58:13.420992Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:58:14.750229Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb92"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils.vis_utils <span class="im">import</span> plot_model</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>plot_model(ensemble, show_shapes<span class="op">=</span><span class="va">True</span>, show_layer_names<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Podemos observar el aspecto que tiene nuestro ensemble. Se puede apreciar que está compuesto por un Input conectado con todos los modelos, la salida de estos modelos estan conectadas con las capas correspondientes a la combinación del resultado que resultan en una Dense de 10 para proporcionar la salida.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:58:25.003636Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:58:25.004012Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T15:58:25.012799Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:58:25.004049Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T15:58:25.011804Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb93"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;epochs&quot;</span>:epochs, <span class="st">&quot;callbacks&quot;</span>: early_stopping}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Entrenaremos nuestro ensemble solamente 1 epoch dado que tarda mucho tiempo y con una epoch es suficiente.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T15:58:26.711829Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T15:58:26.712208Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T16:33:15.359252Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T15:58:26.712264Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T16:33:15.358251Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb94"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ensemble.fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T16:33:15.362918Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T16:33:15.363217Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T16:33:15.367919Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T16:33:15.363248Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T16:33:15.366985Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb95"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Al igual que hemos hecho con todos los modelos durante esta libreta entrenaremos con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T16:33:15.672847Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T16:33:15.673536Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T16:36:36.259719Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T16:33:15.673597Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T16:36:36.258504Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb96"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ensemble.fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez entrenado nuestro ensemble realizamos la predicción sobre el test y realiamos la subida.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T16:37:11.438914Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T16:37:11.439307Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T16:48:42.304317Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T16:37:11.439341Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T16:48:42.303195Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">#probabilities_ensemble = ensemble.predict(testing_preprocessed)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>La predicción de este ensemble también esta comentada, el motivo se verá comentado en la conclusión que se muestra a continuación de este apartado.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-28T16:48:42.306906Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-28T16:48:42.307266Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-28T16:48:42.361955Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-28T16:48:42.307306Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-28T16:48:42.361091Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;predictions = defaultdict(None)  # Dictionary with the predictions</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co">axis = -1</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">labels = np.argmax(probabilities_ensemble, axis)</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">labels = classes[labels]</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">labels = labels[indices]</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">predictions[&quot;esemble&quot;] = np.argmax(labels)</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">data = {&quot;ImageId&quot;: identifiers, &quot;Label&quot;: labels}</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">submission = pd.DataFrame(data).set_index(&quot;ImageId&quot;)</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">path = &quot;ensemblenet_models.csv&quot;</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">submission.to_csv(path, )&quot;&quot;&quot;</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>El resultado de public score obtenido es de: <code>0.99242</code> que es mejor que el obtenido de juntar directamente el resultado de todos los modelos.</p>
</div>
<div class="cell markdown">
<h1 id="section"><a id="resultados"></a></h1>
<h1 id="8-comparativa-de-los-resultados-obtenidos">8. Comparativa de los resultados obtenidos</h1>
<p>Por último, destacar que los mejores resultados se obtienen de realizar un ensemble que combine todos los modelos con una red neuronal y de una combianción de los resultados directa. Además, destacar que se han obtenido unos buenos resultados en las redes convolucionales creadas manualmente. El orden de los modelos solo teniendo en cuenta el resultado de validación serían:</p>
<ul>
<li>El primero es la <strong>red convolucional con filtros grandes</strong></li>
<li>El segundo es la <strong>red VGG19</strong></li>
<li>El tercero es la <strong>red InceptionResNetV2</strong></li>
<li>El cuarto es la <strong>red DenseNet201</strong></li>
<li>El quinto es la <strong>red Xception</strong></li>
<li>El sexto es la <strong>red InceptionV3</strong></li>
<li>El último es la <strong>red convolucional con filtros pequeños</strong></li>
</ul>
<p>Observando estos resultados quizás ubiese sido una buena opción elaborar más modelos de redes convolucionales de forma manual dado que el mejor modelo es uno de ellos. Por lo tanto, viendo que nuestros compañeros seguían teniendo mejores resultados que nosotros decidimos elaborar otra red convolucional manualmente.</p>
</div>
<section id="añadimos-una-red-convolucional-más" class="cell markdown">
<h3>Añadimos una red convolucional más</h3>
<p>Para ello nos basaremos en la primera red convolucional que resultó ser en la mejor red a la hora de la validación. Añadiremos una capa oculta Dense de 512 y reduciremos alguna capa Convolucional.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T10:55:51.647581Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T10:55:51.647927Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T10:55:51.663920Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T10:55:51.647959Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T10:55:51.662684Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_cnn_3():</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    input_shape <span class="op">=</span> (<span class="dv">224</span>,<span class="dv">224</span>,<span class="dv">3</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    activation <span class="op">=</span> <span class="st">&quot;relu&quot;</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_1 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation, input_shape<span class="op">=</span>input_shape)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    layers <span class="op">=</span> [convolutional_layer_1]</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    batch_normalization_1 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_1)</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_2 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_2)</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>    batch_normalization_2 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_2)</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>    max_pooling_layer_1 <span class="op">=</span> keras.layers.MaxPooling2D(<span class="dv">2</span>)</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    layers.append(max_pooling_layer_1)</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>    dropout_layer_1 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_1)</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_3 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">16</span>, kernel_size <span class="op">=</span> <span class="dv">11</span>, strides<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="st">&quot;same&quot;</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_3)</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>    batch_normalization_3 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_3)</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_4 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">32</span>, kernel_size <span class="op">=</span> <span class="dv">13</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_4)</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>    batch_normalization_4 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_4)</span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>    convolutional_layer_5 <span class="op">=</span> keras.layers.Conv2D(filters <span class="op">=</span> <span class="dv">64</span>, kernel_size <span class="op">=</span> <span class="dv">13</span>, strides<span class="op">=</span><span class="dv">1</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>    layers.append(convolutional_layer_5)</span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a>    batch_normalization_5 <span class="op">=</span> keras.layers.BatchNormalization()</span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a>    layers.append(batch_normalization_5)</span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a>    max_pooling_layer_2 <span class="op">=</span> keras.layers.MaxPooling2D(<span class="dv">2</span>)</span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>    layers.append(max_pooling_layer_2)</span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>    dropout_layer_2 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_2)</span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a>    flatten_layer <span class="op">=</span> keras.layers.Flatten(data_format<span class="op">=</span>data_format)</span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a>    layers.append(flatten_layer)</span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>    hidden_layer_1 <span class="op">=</span> keras.layers.Dense(<span class="dv">512</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a>    layers.append(hidden_layer_1)</span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a>    dropout_layer_3 <span class="op">=</span> keras.layers.Dropout(<span class="fl">0.4</span>)</span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a>    layers.append(dropout_layer_3)</span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a>    hidden_layer_2 <span class="op">=</span> keras.layers.Dense(<span class="dv">256</span>, activation<span class="op">=</span>activation)</span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a>    layers.append(hidden_layer_2)</span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a>    output_layer <span class="op">=</span> keras.layers.Dense(<span class="dv">10</span>, activation<span class="op">=</span><span class="st">&quot;softmax&quot;</span>)</span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a>    layers.append(output_layer)</span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a>    modelo <span class="op">=</span> keras.Sequential(layers)</span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="fl">1e-3</span>  <span class="co">#  The learning rate</span></span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> tf.keras.optimizers.Adam(lr)  <span class="co"># Optimizer that implements the Adam algorithm</span></span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> <span class="va">True</span>  <span class="co"># Whether the predictions are a logit tensor</span></span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> keras.losses.SparseCategoricalCrossentropy(logits)</span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> [<span class="st">&quot;accuracy&quot;</span>]</span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a>    modelo.<span class="bu">compile</span>(optimizer, loss, metrics)</span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> modelo</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Lo crearemos igual que el resto de modelos bajo la estrategia <code>Multi-GPU</code>.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T10:55:52.215884Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T10:55:52.216227Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T10:55:52.513744Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T10:55:52.216258Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T10:55:52.512494Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb100"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    cnn_3_model <span class="op">=</span> build_cnn_3()</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T10:55:52.663796Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T10:55:52.664074Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T10:55:52.669764Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T10:55:52.664104Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T10:55:52.668670Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed,<span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Entrenamos el modelo durante 5 epochs.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T10:55:53.109760Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T10:55:53.110584Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T11:49:32.630856Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T10:55:53.110624Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T11:49:32.629890Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cnn_3_model.fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>El modelo resultó en un <code>0.9836</code> siendo nuestro tercer mejor modelo. A continuación, lo entrenaremos con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T11:49:32.632768Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T11:49:32.633098Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T11:49:32.639631Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T11:49:32.633143Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T11:49:32.638511Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">10</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T11:49:32.640984Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T11:49:32.641912Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T11:53:28.541799Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T11:49:32.641948Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T11:53:28.540667Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cnn_3_model.fit(**arguments)</span></span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez entrenado lo guardamos.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T11:53:42.460150Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T11:53:42.460505Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T11:53:44.407037Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T11:53:42.460540Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T11:53:44.405913Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb105"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co">#cnn_3_model.save(&#39;cnn3_model.h5&#39;)</span></span></code></pre></div>
</div>
<section id="juntamos-todos-los-resultados-primer-ensemble" class="cell markdown">
<h3>Juntamos todos los resultados: Primer Ensemble</h3>
<p>Una vez tenemos el nuevo modelo juntaremos todos los resultados como en el primer ensemble.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T11:53:45.708453Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T11:53:45.708770Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T11:53:45.809023Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T11:53:45.708799Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T11:53:45.808101Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the indices for sorting the predictions</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> testing.file_paths</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: os.path.basename(identifier), identifiers)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: os.path.splitext(identifier), identifiers)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">list</span>(identifiers)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>identifiers, _ <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>identifiers)</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: identifier.replace(<span class="st">&quot;img_&quot;</span>, <span class="st">&quot;&quot;</span>), identifiers)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> identifier: <span class="bu">int</span>(identifier), identifiers)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> <span class="bu">list</span>(identifiers)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> np.array(identifiers)</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> np.argsort(identifiers)</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>identifiers <span class="op">=</span> identifiers[indices]</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb107"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> defaultdict(<span class="va">None</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T10:23:13.772142Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T10:23:13.772894Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T10:23:46.769841Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T10:23:13.772942Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T10:23:46.768800Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb108"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;cnn&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/cnn_model.h5&#39;</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;cnn2&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/cnn_2.h5&#39;</span>)</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;cnn3&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/cnn3_model.h5&#39;</span>)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;VGG19&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/vgg19_model.h5&#39;</span>)</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;Xception&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/xception_model.h5&#39;</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;DenseNet201&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/densenet201_model.h5&#39;</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;InceptionV3&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/inceptionv3_model.h5&#39;</span>)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>models[<span class="st">&quot;InceptionResNetV2&quot;</span>] <span class="op">=</span> tf.keras.models.load_model(<span class="st">&#39;../input/models/inceptionresnetv2_model.h5&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T11:53:54.545750Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T11:53:54.546077Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:09:09.847113Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T11:53:54.546109Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:09:09.846019Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb109"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>prob_a <span class="op">=</span> models[<span class="st">&quot;cnn&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>prob_b <span class="op">=</span> models[<span class="st">&quot;cnn2&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(prob_a,prob_b)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>prob_c <span class="op">=</span> models[<span class="st">&quot;cnn3&quot;</span>].predict(testing_preprocessed) </span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_c)</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>prob_d <span class="op">=</span> models[<span class="st">&quot;VGG19&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_d)</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>prob_e <span class="op">=</span> models[<span class="st">&quot;Xception&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_e)</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>prob_f <span class="op">=</span> models[<span class="st">&quot;InceptionV3&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_f)</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>prob_g <span class="op">=</span> models[<span class="st">&quot;InceptionResNetV2&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_g)</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>prob_h <span class="op">=</span> models[<span class="st">&quot;DenseNet201&quot;</span>].predict(testing_preprocessed)</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> np.add(probabilities,prob_h)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez tenemos todas las predicciones sobre el conjunto de test preparamos la subida.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:09:09.849095Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:09:09.849425Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:09:09.895798Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:09:09.849478Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:09:09.894922Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb110"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the predictions</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>axis <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.argmax(probabilities, axis)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> classes[labels]</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> labels[indices]</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>predictions[<span class="st">&quot;esemble&quot;</span>] <span class="op">=</span> np.argmax(labels)</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">&quot;ImageId&quot;</span>: identifiers, <span class="st">&quot;Label&quot;</span>: labels}</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame(data).set_index(<span class="st">&quot;ImageId&quot;</span>)</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">&quot;all_models_with_new_cnn3.csv&quot;</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>submission.to_csv(path, )</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Esta subida resultó en un <code>0.99385</code> que hasta el momento es la mejor subida que hemos tenido.</p>
</div>
<section id="juntamos-todos-los-resultados-segundo-ensemble" class="cell markdown">
<h3>Juntamos todos los resultados: Segundo Ensemble</h3>
<p>A continuación, comprobaremos cómo sería con el segundo tipo de ensemble que hemos visto anteriormente.</p>
</section>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:25:44.235342Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:25:44.235923Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:25:44.245958Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:25:44.235968Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:25:44.244833Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb111"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [<span class="st">&#39;../input/models/cnn_model.h5&#39;</span>,</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/cnn_2.h5&#39;</span>,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/cnn3_model.h5&#39;</span>,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/vgg19_model.h5&#39;</span>,</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/xception_model.h5&#39;</span>,</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/densenet201_model.h5&#39;</span>,</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/inceptionresnetv2_model.h5&#39;</span>,</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;../input/models/inceptionv3_model.h5&#39;</span>]</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:25:46.883558Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:25:46.883960Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:26:52.998320Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:25:46.883999Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:26:52.997358Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb112"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> strategy.scope():</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>    ensemble2 <span class="op">=</span> create_ensemble(models)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez creado el ensemble lo entrenamos con el conjunto de entrenamiento.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:26:53.000365Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:26:53.000703Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:26:53.006087Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:26:53.000739Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:26:53.005051Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb113"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>histories <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the histories</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: training_preprocessed, <span class="st">&quot;validation_data&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:26:53.007684Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:26:53.008317Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:52:48.713984Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:26:53.008355Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:52:48.712459Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb114"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>ensemble2.fit(<span class="op">**</span>arguments)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:52:48.716270Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:52:48.716592Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:52:48.725323Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:52:48.716623Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:52:48.723679Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb115"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Number of epochs to train the model</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>arguments <span class="op">=</span> {<span class="st">&quot;x&quot;</span>: validation_preprocessed, <span class="st">&quot;epochs&quot;</span>:epochs}</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez entrenado con el conjunto de entrenamiento pasamos a entrenar con el conjunto de validación.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:52:48.727429Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:52:48.727983Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T12:55:01.334658Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:52:48.728094Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T12:55:01.333462Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb116"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>ensemble2.fit(<span class="op">**</span>arguments)</span></code></pre></div>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T12:55:01.337857Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T12:55:01.339066Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T13:02:35.217981Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T12:55:01.339107Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T13:02:35.215424Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb117"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>probabilities_ensemble <span class="op">=</span> ensemble2.predict(testing_preprocessed)</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Una vez tenemos la predicción creamos la subida.</p>
</div>
<div class="cell code" data-execution="{&quot;iopub.status.busy&quot;:&quot;2022-12-30T13:02:35.222763Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2022-12-30T13:02:35.223372Z&quot;,&quot;iopub.status.idle&quot;:&quot;2022-12-30T13:02:35.305940Z&quot;,&quot;iopub.execute_input&quot;:&quot;2022-12-30T13:02:35.223416Z&quot;,&quot;shell.execute_reply&quot;:&quot;2022-12-30T13:02:35.303624Z&quot;}" data-trusted="true">
<div class="sourceCode" id="cb118"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> defaultdict(<span class="va">None</span>)  <span class="co"># Dictionary with the predictions</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate output predictions for the input samples</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>axis <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> np.argmax(probabilities_ensemble, axis)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> classes[labels]</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> labels[indices]</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>predictions[<span class="st">&quot;esemble&quot;</span>] <span class="op">=</span> np.argmax(labels)</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the tabular data with the predictions</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {<span class="st">&quot;ImageId&quot;</span>: identifiers, <span class="st">&quot;Label&quot;</span>: labels}</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.DataFrame(data).set_index(<span class="st">&quot;ImageId&quot;</span>)</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Write the predictions to the corresponding file</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">&quot;ensemblenet_models_wiht_new_cnn3.csv&quot;</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>submission.to_csv(path, )</span></code></pre></div>
</div>
<div class="cell markdown">
<p>Esta segunda subida resultó en un <code>0.99271</code> siendo la segunda mejor subida.</p>
</div>
<section id="conclusión" class="cell markdown">
<h3>Conclusión</h3>
<p>Para terminar mencionar que el modelo creado en última estancia ha resultado ser el tercer mejor modelo entre todos. Esto ha ayudado a mejor la puntuación obtenida a la hora de realizar las subidas, que en este caso las dos últimas han sido las dos mejores. También mencionar que el primer ensemble resulta tener una mayor puntuación que el segundo.</p>
</section>
</body>
</html>
